import db from '../../config/db';
import SQL from 'sql-template-strings';

const getStoreDivisionResults = async (params) => {
    return await db.query(SQL`SELECT s.week_id, s.week_date1, s.away_team_id, s.home_team_id, s.alley, s.start_time, 
    MAX(CASE WHEN t.team_id=s.away_team_id THEN t.team_name ELSE NULL END) AS at, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=1 THEN r.player_id ELSE NULL END) AS ap1id, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=1 THEN p.full_name ELSE NULL END) AS ap1, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=1 THEN r.g1 ELSE NULL END) AS ap1g1, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=1 THEN r.g2 ELSE NULL END) AS ap1g2, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=1 THEN r.g3 ELSE NULL END) AS ap1g3, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=1 THEN r.g4 ELSE NULL END) AS ap1g4, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=1 THEN r.g5 ELSE NULL END) AS ap1g5, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=1 THEN r.g6 ELSE NULL END) AS ap1g6, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=1 THEN r.g7 ELSE NULL END) AS ap1g7, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=1 THEN r.g8 ELSE NULL END) AS ap1g8, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=1 THEN r.g9 ELSE NULL END) AS ap1g9, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=1 THEN r.g10 ELSE NULL END) AS ap1g10, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=2 THEN r.player_id ELSE NULL END) AS ap2id, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=2 THEN p.full_name ELSE NULL END) AS ap2, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=2 THEN r.g1 ELSE NULL END) AS ap2g1, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=2 THEN r.g2 ELSE NULL END) AS ap2g2, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=2 THEN r.g3 ELSE NULL END) AS ap2g3, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=2 THEN r.g4 ELSE NULL END) AS ap2g4, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=2 THEN r.g5 ELSE NULL END) AS ap2g5, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=2 THEN r.g6 ELSE NULL END) AS ap2g6, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=2 THEN r.g7 ELSE NULL END) AS ap2g7, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=2 THEN r.g8 ELSE NULL END) AS ap2g8, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=2 THEN r.g9 ELSE NULL END) AS ap2g9, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=2 THEN r.g10 ELSE NULL END) AS ap2g10, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=3 THEN r.player_id ELSE NULL END) AS ap3id, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=3 THEN p.full_name ELSE NULL END) AS ap3, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=3 THEN r.g1 ELSE NULL END) AS ap3g1, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=3 THEN r.g2 ELSE NULL END) AS ap3g2, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=3 THEN r.g3 ELSE NULL END) AS ap3g3, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=3 THEN r.g4 ELSE NULL END) AS ap3g4, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=3 THEN r.g5 ELSE NULL END) AS ap3g5, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=3 THEN r.g6 ELSE NULL END) AS ap3g6, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=3 THEN r.g7 ELSE NULL END) AS ap3g7, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=3 THEN r.g8 ELSE NULL END) AS ap3g8, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=3 THEN r.g9 ELSE NULL END) AS ap3g9, 
    MAX(CASE WHEN r.team_id=s.away_team_id && r.player_num=3 THEN r.g10 ELSE NULL END) AS ap3g10, 
    MAX(CASE WHEN t.team_id=s.home_team_id THEN t.team_name ELSE NULL END) AS ht, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=1 THEN r.player_id ELSE NULL END) AS hp1id, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=1 THEN p.full_name ELSE NULL END) AS hp1, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=1 THEN r.g1 ELSE NULL END) AS hp1g1, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=1 THEN r.g2 ELSE NULL END) AS hp1g2, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=1 THEN r.g3 ELSE NULL END) AS hp1g3, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=1 THEN r.g4 ELSE NULL END) AS hp1g4, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=1 THEN r.g5 ELSE NULL END) AS hp1g5, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=1 THEN r.g6 ELSE NULL END) AS hp1g6, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=1 THEN r.g7 ELSE NULL END) AS hp1g7, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=1 THEN r.g8 ELSE NULL END) AS hp1g8, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=1 THEN r.g9 ELSE NULL END) AS hp1g9, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=1 THEN r.g10 ELSE NULL END) AS hp1g10, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=2 THEN r.player_id ELSE NULL END) AS hp2id, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=2 THEN p.full_name ELSE NULL END) AS hp2, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=2 THEN r.g1 ELSE NULL END) AS hp2g1, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=2 THEN r.g2 ELSE NULL END) AS hp2g2, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=2 THEN r.g3 ELSE NULL END) AS hp2g3, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=2 THEN r.g4 ELSE NULL END) AS hp2g4, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=2 THEN r.g5 ELSE NULL END) AS hp2g5, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=2 THEN r.g6 ELSE NULL END) AS hp2g6, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=2 THEN r.g7 ELSE NULL END) AS hp2g7, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=2 THEN r.g8 ELSE NULL END) AS hp2g8, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=2 THEN r.g9 ELSE NULL END) AS hp2g9, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=2 THEN r.g10 ELSE NULL END) AS hp2g10, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=3 THEN r.player_id ELSE NULL END) AS hp3id, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=3 THEN p.full_name ELSE NULL END) AS hp3, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=3 THEN r.g1 ELSE NULL END) AS hp3g1, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=3 THEN r.g2 ELSE NULL END) AS hp3g2, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=3 THEN r.g3 ELSE NULL END) AS hp3g3, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=3 THEN r.g4 ELSE NULL END) AS hp3g4, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=3 THEN r.g5 ELSE NULL END) AS hp3g5, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=3 THEN r.g6 ELSE NULL END) AS hp3g6, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=3 THEN r.g7 ELSE NULL END) AS hp3g7, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=3 THEN r.g8 ELSE NULL END) AS hp3g8, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=3 THEN r.g9 ELSE NULL END) AS hp3g9, 
    MAX(CASE WHEN r.team_id=s.home_team_id && r.player_num=3 THEN r.g10 ELSE NULL END) AS hp3g10 
    FROM results AS r JOIN players AS p ON (r.player_id=p.player_id) JOIN teams AS t ON (r.team_id=t.team_id) JOIN (SELECT week_id, DATE_FORMAT(week_date, "%b-%d, %Y") AS week_date1, away_team_id, home_team_id, alley, start_time FROM schedule WHERE season_id=${params.season} && store_id=${params.store} && division_id=${params.division} ORDER BY week_id DESC, start_time ASC, alley ASC) AS s ON (r.week_id=s.week_id AND (r.team_id=s.away_team_id || r.team_id=s.home_team_id)) WHERE r.season_id=${params.season} && r.store_id=${params.store} && r.division_id=${params.division} GROUP BY r.week_id, s.start_time, s.alley ORDER BY r.week_id DESC, s.start_time ASC, s.alley ASC, r.team_id ASC, r.player_num ASC`);
};

const getResultsSeasonsList = async (params) => {
    return await db.query(SQL`SELECT DISTINCT(r.season_id), se.season_id, se.season_name, se.year FROM results AS r JOIN seasons AS se ON (r.season_id=se.season_id) WHERE r.store_id=${params.store} && r.division_id=${params.division} ORDER BY se.season_id DESC;`);
};

module.exports = {
    getStoreDivisionResults,
    getResultsSeasonsList,
};
